#include <tchar.h>
#include <Windows.h>

// Injecting Dll using VirutalAllocEx/WriteProcessMemory
// Invoking dll by using LoadLibrary/GetModuleHandle/CreateRemoteThread

int _tmain(int argc, TCHAR* argv[]) {

	int pid = 8232; // Change PID 
	char* dll_path = "dll.dll"; // Change dll 

	HANDLE procHandle = OpenProcess(PROCESS_ALL_ACCESS, NULL, pid);

	if (procHandle == INVALID_HANDLE_VALUE) {
		_tprintf(TEXT("Cannot open process\r\n"));
		return 1;
	}

	LPVOID ptrArg = VirtualAllocEx(procHandle, NULL, strlen(dll_path), MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);

	if (ptrArg == NULL) {
		_tprintf(TEXT("Cannot allocate memory in remote process \r\n"));
		return 1;
	}

	if (WriteProcessMemory(procHandle, ptrArg, dll_path, strlen(dll_path), NULL) == 0) {
		_tprintf(TEXT("Cannout write to remote process memory \r\n"));
		return 1;
	}

	LPVOID ptrAddr = (LPVOID)GetProcAddress(GetModuleHandle(TEXT("kernel32.dll")), "LoadLibraryA");

	if (ptrAddr == NULL) {
		_tprintf(TEXT("Cant load the LoadLibrary function"));
		return 1;
	}

	DWORD tid;
	HANDLE hThread = CreateRemoteThread(procHandle, NULL, 0, (LPTHREAD_START_ROUTINE)ptrAddr, ptrArg, NULL, &tid);

	if (hThread == NULL) {
		_tprintf(TEXT("Cannot create remote thread \r\n"));
		return 1;
	}
	else {
		_tprintf(TEXT("Remote thread created with the id: %d\r\n"), tid);
	}
	CloseHandle(procHandle);
	return 0;
}
