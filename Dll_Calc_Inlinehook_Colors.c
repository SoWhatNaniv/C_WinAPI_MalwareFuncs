// dllmain.cpp : Defines the entry point for the DLL application.
#include "pch.h"
#include <windows.h>
#include <winternl.h>
#include <TlHelp32.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

const COLORREF colors_list[5] = { 0x000000FF ,0x0000FF00 ,0x00FF0000 ,0x00000000, 0x00FFFFFF }; // Red, Green, White, Black, Blue
int counter = 0;
COLORREF temp_color = 0;
DWORD SetTextColorAddress;
DWORD ReturnAddress;

BOOL APIENTRY DllMain( HMODULE hModule, DWORD  ul_reason_for_call, LPVOID lpReserved) {
    SetTextColorAddress = GetProcAddress(GetModuleHandle("gdi32.dll"), "SetTextColor");
    ReturnAddress = SetTextColorAddress + 2;
    Hook();
    return TRUE;
}

void __declspec(naked) SetTextColorHook() {
    temp_color = colors_list[counter % 5];
    counter = counter + 1;
    _asm {
        mov eax, temp_color
        mov [esp+8], eax
        jmp ReturnAddress
    }
}

void Hook() {
    DWORD RelativeSetTextColorHookAddress = 0x0;
    DWORD old;
    const char jmp_long[5] = {0xE9, 0x0, 0x0, 0x0, 0x0};

    VirtualProtect(SetTextColorAddress - 5, 0x7, PAGE_READWRITE, &old);
    RelativeSetTextColorHookAddress = (DWORD)&SetTextColorHook - SetTextColorAddress;
    memcpy(jmp_long + 1, &RelativeSetTextColorHookAddress, 0x4);
    AtomicWriting(SetTextColorAddress - 5, jmp_long);
}

void AtomicWriting(LPVOID destination, LPVOID source) {
    BYTE buffer[8] = {0x0, 0x0, 0x0, 0x0, 0x0, 0xEB, 0xF9, 0x55}; // Added jump short 5 and push ebp, known opcodes (:

    memcpy(buffer, source, 5);

    __asm
    {
        lea esi, buffer;
        mov edi, destination;

        mov eax, [edi];
        mov edx, [edi + 4];
        mov ebx, [esi];
        mov ecx, [esi + 4];

        lock cmpxchg8b[edi];
    }
}
