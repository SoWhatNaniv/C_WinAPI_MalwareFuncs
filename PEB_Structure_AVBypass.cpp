#include <Windows.h>
#include "stdio.h"
#include <winternl.h>

int main()
{
	PPEB pPEB = 0;
	PLDR_DATA_TABLE_ENTRY pLdrDataTableEntry = 0;
	#ifdef _WIN64
		pPEB = (PPEB)__readgsdword(0x60);
	#else
		pPEB = (PPEB)__readfsdword(0x30);
	#endif 

	printf("PEB Address at: %p\n",pPEB);
	printf("Ldr Address at: %p\n", pPEB->Ldr);
	printf("InMemoryOrderModuleList Address at: %p\n", pPEB->Ldr->InMemoryOrderModuleList);


	PLIST_ENTRY pLE = &(pPEB->Ldr->InMemoryOrderModuleList);

	// Printing all loaded modules
	printf("\nLoaded Moduels:\n");
	for (PLIST_ENTRY pl = pLE->Flink; pl != pLE; pl = pl->Flink)
	{
		pl = pl - 1;
		pLdrDataTableEntry = (PLDR_DATA_TABLE_ENTRY)pl;
		printf("%ls \t%p\n", pLdrDataTableEntry->FullDllName.Buffer, (DWORD)pLdrDataTableEntry->DllBase);
		pl = pl + 1;
	}
}
